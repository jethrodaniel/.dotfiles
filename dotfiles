#!/usr/bin/env bash

this_dir="$(dirname "$(readlink -f "$0")")"
# shellcheck source=helpers.sh
source "${this_dir}/helpers.sh"

# From <https://docs.brew.sh/Homebrew-on-Linux>
setup_homebrew() {
  sudo apt-get install build-essential curl file git gcc
  sh -c "$(curl -fsSL https://raw.githubusercontent.com/Linuxbrew/install/master/install.sh)"
  eval $(/home/linuxbrew/.linuxbrew/bin/brew shellenv)
  export PATH="/home/linuxbrew/.linuxbrew/bin:$PATH"

  # For CI
  eval $(~/.linuxbrew/bin/brew shellenv)
  export PATH="~/.linuxbrew/bin:$PATH"
}

install_gems() {
  curl https://raw.githubusercontent.com/jethrodaniel/.git-hooks/master/install.sh | bash

  gem install ripper-tags
  gem install gem-ripper-tags
  gem ripper_tags
  gem install gem-browse
  gem install haml-lint
}

install_dotfiles() {
  #git clone --recurse-submodules https://github.com/jethrodaniel/dotfiles "$HOME/dotfiles/"

  echo "Updating \`apt\` ..."
  sudo apt-get update

  echo "Setting up Homebrew ..."
  setup_homebrew

  echo "Running \`brew bundle\`..."
  brew bundle --file=dotfiles/Brewfile

  rbenv install 2.6.1 || exit 1

  echo "Installing dotfiles with \`stow\` ..."
  if stow --target="$HOME" --dir="dotfiles" home; then
    echo 'Installed symlinks ...'
  else
    echo '`stow` failed. You probably need to delete existing files.'
    ./stow.rb home
  fi

  echo "Installing misc packages from \`apt\`..."
  sudo apt-get install -y \
    x11-xkb-utils \
    xbacklight \
    compton \
    i3 \
    pavucontrol \
    ttf-ancient-fonts

  "Installing some ruby gems ..."
  install_gems

  echo "Linking tmux config ..."
  # Symlink tmux settings into the home dir
  ln -fs ~/.tmux/conf ~/.tmux.conf

  say <<-MSG
		Done. Be sure to run

			\`prefix+I\` inside tmux, then reopen tmux.
	MSG
}

PROGNAME=$0

usage() {
  cat <<-EOF
		Usage: $PROGNAME [-v] [-y] [install]

		Commands
		  install    Installs these dotfiles
		  <blank>    With no options, shows usage

		Options
		  -y    Reply \`y\` to any prompts

	EOF
}

main() {
  # Parse options
  while getopts ':y' o; do
    case $o in
      y) force_yes=true
        ;;
      *)
    esac
  done
  shift $((OPTIND-1))

  if [ "$1" != 'install' ]; then
    usage
    exit
  fi

  say <<-MSG
		Setting up dotfiles...

		This is probably going to take a while. Time for â˜•.
	MSG


  echo 'Installing the dotfiles...'
  install_dotfiles
}

main "$@"
